<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CV Builder - AI helper</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="container">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h1>CV Builder (AI helper)</h1>
      <div id="user-area"></div>
    </header>

    <div class="layout">
      <form id="cv-form" class="form">
        <div class="form-section">
          <label>Full name<input name="name" required /></label>
          <label>Email<input name="email" type="email" /></label>
          <label>Phone<input name="phone" /></label>
          <label>Location<input name="location" /></label>
          <label>Photo (optional)<input id="photo-input" name="photo" type="file" accept="image/*" /></label>
        </div>

        <div class="form-section entries">
          <h3>Experience <button id="add-exp" type="button" class="small">+ add</button></h3>
          <div id="experience-list"></div>
        </div>

        <div class="form-section entries">
          <h3>Education <button id="add-edu" type="button" class="small">+ add</button></h3>
          <div id="education-list"></div>
        </div>

        <div class="form-section">
          <label>Skills (comma separated)<input name="skills" placeholder="JavaScript, React, Node.js" /></label>
          <label>AI prompt or bullet points (optional)<textarea name="prompt" placeholder="Short summary or bullets to ask AI to expand"></textarea></label>
        </div>

        <div class="form-actions">
          <button id="preview-btn" type="button">Update Preview</button>
          <button id="generate-btn" type="submit">Generate CV (PDF)</button>
        </div>

        <div id="status" class="status"></div>
      </form>

      <aside class="preview">
        <h2>Live Preview</h2>
        <div id="cv-preview" class="cv-frame"></div>

        <div style="margin-top:12px;">
          <h3>My CVs</h3>
          <div id="my-cvs-list">(login to see your saved CVs)</div>
        </div>
      </aside>
    </div>
  </main>

  <script src="auth.js"></script>
  <script src="app.js"></script>
  <script>
    // show user info and login/logout links
    (function(){
      const userArea = document.getElementById('user-area');
      function getToken() {
        return localStorage.getItem('cv_token') || localStorage.getItem('cvbuilder_token') || sessionStorage.getItem('cv_token') || sessionStorage.getItem('cvbuilder_token');
      }
      function getUser() {
        return JSON.parse(localStorage.getItem('cv_user') || sessionStorage.getItem('cv_user') || localStorage.getItem('cvbuilder_user') || sessionStorage.getItem('cvbuilder_user') || 'null');
      }
      const user = getUser();
      const token = getToken();
      if (user && token) {
        userArea.innerHTML = `<div style="display:flex;gap:10px;align-items:center"> <div>${user.name||user.email}</div> <button id="logout-btn">Logout</button></div>`;
        document.getElementById('logout-btn').addEventListener('click', ()=>{
          localStorage.removeItem('cv_token'); localStorage.removeItem('cv_user'); localStorage.removeItem('cvbuilder_token'); localStorage.removeItem('cvbuilder_user'); sessionStorage.removeItem('cv_token'); sessionStorage.removeItem('cv_user'); sessionStorage.removeItem('cvbuilder_token'); sessionStorage.removeItem('cvbuilder_user');
          window.location.reload();
        });
        // fetch my CVs
        fetchMyCvs();
      } else {
        userArea.innerHTML = `<a href="login.html" style="color:#2563eb">Sign in</a> <a href="signup.html" style="margin-left:8px;color:#2563eb">Sign up</a>`;
      }

      async function fetchMyCvs(){
        const token = getToken();
        if (!token) return;
        try {
          const res = await fetch('/api/my-cvs', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) return;
          const data = await res.json();
          const list = document.getElementById('my-cvs-list');
          if (!data.files || !data.files.length) { list.innerText = 'No saved CVs yet'; return; }
          list.innerHTML = '';
          data.files.forEach(f => {
            const div = document.createElement('div');
            const dl = document.createElement('button');
            dl.textContent = 'Download';
            dl.addEventListener('click', async () =>{
              try {
                const r = await fetch('/api/my-cvs/download/' + encodeURIComponent(f.name), { headers: { 'Authorization': 'Bearer ' + token } });
                if (!r.ok) { alert('Failed to download'); return; }
                const blob = await r.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = f.name; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
              } catch (e) { console.error(e); alert('Download error'); }
            });
            div.textContent = f.name + ' ';
            div.appendChild(dl);
            list.appendChild(div);
          });
        } catch (e) { console.error('Fetch my cvs', e); }
      }
    })();
  </script>
</body>
</html>
